



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="ROBOTS" content="NOINDEX,NOFOLLOW,NOARCHIVE">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>無線制御(GRAFFIAS) &mdash; Nichiden 0.9 RC ドキュメント</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/my_theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  

  
        <link rel="index" title="索引"
              href="../genindex.html"/>
        <link rel="search" title="検索" href="../search.html"/>
    <link rel="top" title="Nichiden 0.9 RC ドキュメント" href="../index.html"/>
        <link rel="next" title="配線" href="../haisen.html"/>
        <link rel="prev" title="無線制御(Acrabの実装解説)" href="acrab-code.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>
  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-102450326-2', 'auto');
    ga('send', 'pageview');
  </script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Nichiden
          

          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">最近更新した記事</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../twinkle.html">またたき回路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software.html">日周緯度変(外部制御アプリ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software-code.html">日周緯度変(Ogoseの実装解説)</a></li>
<li class="toctree-l1"><a class="reference internal" href="piscium.html">無線制御(PISCIUM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wireless.html">無線制御</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protect.html">過電圧保護回路</a></li>
</ul>
<p class="caption"><span class="caption-text">目次</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../main.html">東京大学地文研究会天文部 日電引き継ぎ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../management.html">プロジェクト マネジメント</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/kikou.html">日周緯度変(日周緯度変換機構)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/saitama.html">日周緯度変(さいたま)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/ikebukuro.html">日周緯度変(Ikebukuro)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software.html">日周緯度変(外部制御アプリ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software-history.html">日周緯度変(外部制御アプリの歴史)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nissyu-idohen/pc-software-code.html">日周緯度変(Ogoseの実装解説)</a></li>
<li class="toctree-l1"><a class="reference internal" href="wireless.html">無線制御</a></li>
<li class="toctree-l1"><a class="reference internal" href="piscium.html">無線制御(PISCIUM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="acrab.html">無線制御(Acrab)</a></li>
<li class="toctree-l1"><a class="reference internal" href="acrab-code.html">無線制御(Acrabの実装解説)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">無線制御(GRAFFIAS)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">概要</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">使い方</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">下準備と起動</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">操作</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#json">JSONファイルの作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id5">JSONリストの作成</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id6">プログラム</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#graffias-php-html">GRAFFIAS.phpの実装解説(HTML部)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#script-js">script.jsの実装解説</a></li>
<li class="toctree-l3"><a class="reference internal" href="#graffias-php-php">GRAFFIAS.phpの実装解説(php部)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#form">FORMから送信されたデータの変数への格納</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">JSONファイルとして出力するための雛形の作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">星座絵用セレクトボックスで、星座が未選択の場合の配列からの削除</a></li>
<li class="toctree-l4"><a class="reference internal" href="#on-off">on/off関連の配列作成</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scinariojson">scinarioの中に入れる配列の作成とJSONの出力</a></li>
<li class="toctree-l4"><a class="reference internal" href="#json-1">JSONリストの作成</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id10">今後の課題点</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../twinkle.html">またたき回路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../protect.html">過電圧保護回路</a></li>
<li class="toctree-l1"><a class="reference internal" href="../haisen.html">配線</a></li>
<li class="toctree-l1"><a class="reference internal" href="../haisen-kagoshii.html">配線(かごしい内)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bihin.html">備品管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../syutou.html">主投影機との連携</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hojotou.html">補助投影機との連携</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/buy_parts.html">部品の買い方</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/electronic-design.html">回路設計のためのソフトウェア</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/microcontroller.html">マイコンをはじめよう</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/editor.html">テキストエディタを使ってみよう</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/visualstudio.html">Visual Studioをはじめよう</a></li>
<li class="toctree-l1"><a class="reference internal" href="../begginers/windows.html">無料でWindowsを手に入れる</a></li>
<li class="toctree-l1"><a class="reference internal" href="../handover.html">引き継ぎ資料の作成方法</a></li>
<li class="toctree-l1"><a class="reference internal" href="../honban.html">【直前特集】本番で気をつけたい三箇条</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nichiden</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Nichiden</a> &raquo;</li>
        
      <li>無線制御(GRAFFIAS)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/wireless/graffias.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div itemprop="articleBody">
              
  <div class="section" id="graffias">
<h1>無線制御(GRAFFIAS)<a class="headerlink" href="#graffias" title="このヘッドラインへのパーマリンク">¶</a></h1>
<ul class="simple">
<li>書いた人: Hanaka Satoh(nichiden_28)</li>
<li>更新日時: 2018/08/26</li>
<li>実行に必要な知識・技能: Web制作、JavaScript、php</li>
<li>タスクの重さ: 2/数日かかる</li>
<li>タスクの必須度: 4/毎年やるべき</li>
</ul>
<div class="section" id="id1">
<h2>概要<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>は28代で開発した指示書作成補助用Webアプリケーションです。現状、<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>で使用するJSON形式の指示書を作成しやすくする機能のみを持ちます。
最新のブラウザ(Chrome推奨)があれば、どんな環境でも使うことができます。</p>
<p><code class="docutils literal notranslate"><span class="pre">Acrab</span></code>の補助として用いることから、さそり座β星<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>の別名である<code class="docutils literal notranslate"><span class="pre">Graffias</span></code>から名前を取っていますがあまり深い意味はありません。<code class="docutils literal notranslate"><span class="pre">Graffias</span></code>はラテン語で「爪」を意味するそうですが本アプリに爪要素は一切ありません。</p>
<p>※無線制御と直接関係はしませんが、性質上<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>から切り離せないアプリなので無線制御の項に分類しました。</p>
</div>
<div class="section" id="id2">
<h2>使い方<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id3">
<h3>下準備と起動<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>使いはじめる前に、その年に使用する星座絵を<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>に入力する必要がある。<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>内のHTML部分に、</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">select</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;projector_a[0]&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;projector_a[0]&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;XXX&quot;</span><span class="p">&gt;</span>--使用星座絵を選択--<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>などと書かれた部分がある。(<code class="docutils literal notranslate"><span class="pre">projector</span></code>は5個まで用意しているので計5か所、1か所書いてコピペすればよい)
この後に、使用する星座絵及び星座グループを、(※ただし、2017年現在Acrab側の不具合により現状星座グループ指定は行えないので注意)</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Lep&quot;</span><span class="p">&gt;</span>うさぎ<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>のように、<code class="docutils literal notranslate"><span class="pre">&lt;option</span> <span class="pre">value=&quot;(三文字コード)&quot;&gt;(星座名か星座グループ名)&lt;/option&gt;</span></code>の形で書いていく。
<code class="docutils literal notranslate"><span class="pre">ACRAB</span></code>ディレクトリ内に、<code class="docutils literal notranslate"><span class="pre">88星座+略符一覧.txt</span></code>という三文字コードと星座名の対応を書いたテキストファイルを置いておいたので参考程度にどうぞ。</p>
<p>書き換えが終わったら、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>を使う環境の整備を行う。
<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>はphpで書かれているので、<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>と同様にローカルにWebサーバを立てないと使えない。
ローカルにWebサーバを立てる方法としては<a class="reference external" href="acrab.html">Acrabの使い方#下準備</a>を参照のこと。<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>本体とはルート環境を別にしておこう。</p>
<p>なお、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>のみを別のPCで使うときは、<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>ディレクトリ内の<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>ディレクトリのみを移せば使える仕様になっている。
これにより、プログラミング担当者以外の人や日電メンバー以外にも指示書作成を手伝ってもらえる…といいなあ。</p>
<p>localhostにアクセスすると、以下のような画面が表示される。</p>
<div class="figure" id="id11">
<img alt="GRAFFIASメイン画面" src="../_images/graffias-main.png" />
<p class="caption"><span class="caption-text">GRAFFIASメイン画面</span></p>
</div>
</div>
<div class="section" id="id4">
<h3>操作<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="json">
<h4>JSONファイルの作成<a class="headerlink" href="#json" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>で作成しようとするJSONの構造は以下のとおり。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>├── &quot;info&quot; [番組情報]
│   ├── &quot;day&quot; [(ライブ解説の場合)何日目か]
│   ├── &quot;title&quot; [番組名]
│   └── &quot;name&quot; [担当者名]
└── &quot;scenario&quot; [配列: 指示が入る部分]
    ├── 0
    │   ├── &quot;word&quot; [セリフ: 0番目は空欄にする]
    │   ├── &quot;timing&quot; [タイミング: 0番目は空欄にする]
    │   └── &quot;projector&quot; [投影機]
    │       ├── &quot;(三文字コード)&quot; [点灯なら1/消灯なら0]
    │       └── (以下同様)
    ├── 1
    │   ├── &quot;word&quot; [セリフ]
    │   ├── &quot;timing&quot; [タイミング]
    │   └── &quot;projector&quot; [投影機]
    │       ├── &quot;(三文字コード)&quot; [点灯なら1/消灯なら0]
    │       └── (以下同様)
    └── (以下同様)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>の画面上の各フォームは、このJSONの構造に対応している。</p>
<div class="figure" id="id12">
<img alt="GRAFFIAS操作画面" src="../_images/graffias-opscreen.png" />
<p class="caption"><span class="caption-text">GRAFFIAS操作画面</span></p>
</div>
<ul class="simple">
<li>ファイル名…JSONファイルのファイル名。自由に決めていいが、タイトルと一致させた方が分かりやすいと思われる。</li>
<li>公演日…<code class="docutils literal notranslate"><span class="pre">day</span></code>と対応。セレクトボックスから一日目～三日目、ソフトのいずれかを選ぶ。</li>
<li>タイトル…<code class="docutils literal notranslate"><span class="pre">title</span></code>と対応。番組名を入力する。</li>
<li>担当者…<code class="docutils literal notranslate"><span class="pre">name</span></code>と対応。担当者の名前を入力する。ソフト製作の番組の場合、空白にしておくといいだろう。</li>
<li>シナリオ以下…<code class="docutils literal notranslate"><span class="pre">scenario</span></code>以下に対応する。下のプラスボタンを押せばフォームが増え、マイナスボタンを押せば直前のフォームが消える。0番目は「JSONを作成」ボタンを押した時に自動生成されるので、入力不要である。</li>
<li>タイミング…<code class="docutils literal notranslate"><span class="pre">timing</span></code>と対応。セリフの前か後かを選択できるようにしたが、その他の「セリフの3秒ほど後」のような指示は<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>上では対応できないので、出来上がったJSONに手入力することになる。</li>
<li>操作…<code class="docutils literal notranslate"><span class="pre">projector</span></code>と対応。星座絵と、その星座絵のon/offを選択する。入力ミスが一番多いところなので注意。
星座のグループも選択できるが、Acrabがこれに対応できていないので現状無効である。詳しくは<a class="reference external" href="acrab-code.html">Acrabの実装解説#acrab_main.js</a>参照のこと。</li>
<li>セリフ…星座絵点灯/消灯の合図となるセリフ。エクセルからコピペ可。</li>
</ul>
<p>情報を入力していると、指示書の曖昧な点や不明点、矛盾点が見えてくることもある。これらは入力中にソフトの人やライブ解説担当者に問い合わせて、できるだけ潰しておくといいだろう。</p>
<p>全ての情報を入力し終わったら右下の「JSONを作成」ボタンをクリックする。
すると、JSONファイルが<code class="docutils literal notranslate"><span class="pre">GRAFFIAS/scenario</span></code>ディレクトリ内に作成される。</p>
<div class="line-block">
<div class="line">実は、このままでは<strong>AcrabからJSONファイルを参照できない</strong>ため、JSONファイルが揃ったら、
<strong>ACRAB/scenarioディレクトリ内にJSONファイルをコピーして使う</strong>のが必須となる。</div>
<div class="line">なぜこんな面倒な仕様なのかというと、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>は、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>のみをコピーしてプログラム担当ではない人に渡して使ってもらうことを想定しているためである。
年にもよるが、基本的に指示書の数は多いうえに大体本番ギリギリにならないと揃わない。このため、とにかく作業人数が多いほど本番直前の負担が減る。よって、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>ディレクトリのみをコピーして複数人に渡し、各自の<code class="docutils literal notranslate"><span class="pre">GRAFFIAS/scinario</span></code>内に出力されたJSONを、USBなりLINEなりメールなりでJSONを取りまとめる人に送信する…ということを考えた。
全員がGitを使いこなせれば無問題な気もするが、そういう専門知識のない人にも容易に使えるような仕様を目指したのでこうなった。</div>
</div>
</div>
<div class="section" id="id5">
<h4>JSONリストの作成<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>全ての番組のJSONファイルを作成し終わったら、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS/scenario</span></code>ディレクトリに全ての番組のJSONファイルがあることを確認する。
<strong>GRAFFIASディレクトリがACRABディレクトリの直下にあることも確認する。</strong></p>
<div class="line-block">
<div class="line">ここまで確認できたら、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>の画面で「<strong>↑↑↓↓←→←→BA</strong>」と入力すると、画面一番下の右側(赤っぽいエリアの外)に赤い「JSONリストの作成」ボタンが表示される。
これをクリックすると、<code class="docutils literal notranslate"><span class="pre">ACRAB</span></code>ディレクトリ内に<code class="docutils literal notranslate"><span class="pre">scenario_list.json</span></code>が作成される。</div>
<div class="line">既に<code class="docutils literal notranslate"><span class="pre">scenario_list.json</span></code>がある状態で押すと、これが上書きされる仕様。
このため直前のタイトル変更にもササッと対応できる。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">scenario_list.json</span></code>は、<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>がサーバにある指示書ファイルの数を知るために使われる。詳しくは<a class="reference external" href="acrab-code.html">Acrabの実装解説#acrab_main.js</a>参照のこと。</div>
</div>
</div>
</div>
</div>
<div class="section" id="id6">
<h2>プログラム<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>はWebの技術を使って内部処理や画面表示を行っている。
画面の情報はHTML、デザインはCSS、画面の書き換えはJavaScript(以下JS)、内部処理やファイルの生成はphpという構成だ。</div>
<div class="line">phpの仕様上、HTMLは<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>の中に書いてある。基本的にはphpをプログラム前半に、HTML部分をプログラムの後半に書いてあるので、編集時はそれぞれを参照してほしい。</div>
</div>
<p>プログラムの細かい仕様については説明を省くが、要所については説明を加えておく。</p>
<div class="section" id="graffias-php-html">
<h3>GRAFFIAS.phpの実装解説(HTML部)<a class="headerlink" href="#graffias-php-html" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">GRAFFIAS</span></code>では、入力された情報を受け取るのに、HTMLの<code class="docutils literal notranslate"><span class="pre">&lt;FORM&gt;</span></code>タグを使用している。<code class="docutils literal notranslate"><span class="pre">&lt;FORM&gt;</span></code>タグ内にラジオボタン、セレクトボックス、テキストボックス等を配置し、入力された情報を</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;frm&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;frm&quot;</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;GRAFFIAS.php&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span> <span class="p">&gt;</span>
</pre></div>
</div>
<p>で<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>に送信する。送信したデータをphp部分で処理するという流れだ。php部分の説明は後述。</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">select</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;projector_a[0]&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;projector_a[0]&quot;</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">等のセレクトボックスについては、セレクトボックスの中身をいじれば、その年に使用する星座にも対応できる。
セレクトボックスの中身を操作するようなGUIは、時間の都合上作ることができなかったので、もし余裕があったら考えてみるのもいいかもしれない。(GUIを丸ごと作り直した方が速いかもしれないが…)</div>
<div class="line">他のHTML部については、後述する<code class="docutils literal notranslate"><span class="pre">script.js</span></code>に関連する部分以外は、基本的にググればすぐ分かる程度の内容しか書いていないため、割愛する。</div>
</div>
</div>
<div class="section" id="script-js">
<h3>script.jsの実装解説<a class="headerlink" href="#script-js" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>一旦<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>からは外れるが、<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>のフォームの追加・削除機能に関する部分である、<code class="docutils literal notranslate"><span class="pre">script.js</span></code>の解説に入る。</p>
<p><code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>には、フォーム追加用の+ボタンと、フォーム削除用の-ボタンがあるが、これは<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>のみではただのボタンであり、何の機能もない。
これにフォームを追加/削除し、現在のフォームの数を変数を用いカウントして<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>に渡すのが<code class="docutils literal notranslate"><span class="pre">script.js</span></code>の主な役割である。</p>
<p>また、<code class="docutils literal notranslate"><span class="pre">script.js</span></code>には<code class="docutils literal notranslate"><span class="pre">jQuery</span></code>が使われている。これは<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>関連のjavascriptを触った人ならお馴染みであろう。ネット上に参考文献が大量にあるので分からない場合は参照してほしい。
今回は<a class="reference external" href="https://qiita.com/SiskAra/items/5f4bc7ee4e598b863add">こちらのページ</a>を参考にした…というかほとんど丸パクしたのでまずリンク先を参照してほしい。</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">$(obj).attr('id').replace(/\[\d{1,3}\]+$/,</span> <span class="pre">'['</span> <span class="pre">+</span> <span class="pre">frm_cnt</span> <span class="pre">+</span> <span class="pre">']')</span></code>などの<code class="docutils literal notranslate"><span class="pre">/\[\d{1,3}\]+$/</span></code>の部分は「正規表現」と呼ばれる表記である。
ここだけではなく、日電が作成した他のプログラムにも含まれている…し、プログラミングに関わったことがあるなら見たことがあるかもしれない。
表記がややこしいので、<a class="reference external" href="https://www.sejuku.net/blog/20973#i-3">参考文献へのリンク</a>を貼っておく。</li>
</ul>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#send_button&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span>
       <span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="s1">&#39;frm&#39;</span><span class="p">].</span><span class="nx">elements</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">].</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">frm_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
       <span class="nb">document</span><span class="p">.</span><span class="nx">frm</span><span class="p">.</span><span class="nx">submit</span><span class="p">();</span>
   <span class="p">});</span>
</pre></div>
</div>
<p>上記の部分は、「JSONを作成」ボタンを押した時に、現在のフォームの数を、<code class="docutils literal notranslate"><span class="pre">script.js</span></code>内でフォームの数を数える変数である、<code class="docutils literal notranslate"><span class="pre">frm_cnt</span></code>の数に1を足した数として<code class="docutils literal notranslate"><span class="pre">GRAFFIAS.php</span></code>内のHTML部に組み込むためのコードである。これは、javascriptで変更したフォームの数を、どうしてもphp側で参照できるようにしたかったからである。
色々と調べてはみたが、作成者の技術では、javascript→HTML→phpという流れで受け渡す方法しか思いつかなかったのでこの仕様である。もっとスマートな方法もあるのかもしれない。</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">inputKey</span> <span class="o">=</span> <span class="p">[];</span>
     <span class="kd">var</span> <span class="nx">konamiCommand</span> <span class="o">=</span> <span class="p">[</span><span class="mi">38</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">65</span><span class="p">];</span>
     <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">keyup</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">inputKey</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">inputKey</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">konamiCommand</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#listmake&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">,</span><span class="s2">&quot;inline&quot;</span><span class="p">);</span>
            <span class="nx">inputKey</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>
      <span class="p">});</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">…上記の部分は、完全にお遊びで入れてしまった部分である。指示書用のJSONを全て作成し終わった後、<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>から参照できるように、JSONの一覧をまとめたJSONファイルを作らないといけないのだが、このJSONリストを作る機会は少ない。というか基本1回しかない。</div>
<div class="line">このため、隠しコマンドでJSONリスト作成用のボタンが出せたらいいな…隠しコマンドと言えばコナミコマンドかな？という発想から付け足しただけである。(と思ったが同世代に伝わらなかった)世の中同じことを考える人は多いようで、「コナミコマンド　javascript」でググるといろいろ文献が出てくる。このコードもネット上から引っ張ってきた。</div>
</div>
</div>
<div class="section" id="graffias-php-php">
<h3>GRAFFIAS.phpの実装解説(php部)<a class="headerlink" href="#graffias-php-php" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="line-block">
<div class="line">さて、ここからが本題のphp部分になる。php初学者が何とか動くように1週間で無理矢理書き上げたものなので、非常にエラーが多いことに留意していただきたい。</div>
<div class="line">冒頭の、<code class="docutils literal notranslate"><span class="pre">ini_set('display_errors',</span> <span class="pre">&quot;Off&quot;);</span></code>をコメントアウトすると、phpの実行時にエラーが表示されるようになる。デバッグ時の参考にしてほしい。</div>
</div>
<div class="section" id="form">
<h4>FORMから送信されたデータの変数への格納<a class="headerlink" href="#form" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">if(isset($_POST[&#39;filename&#39;])){</span>
<span class="x">    $filename = $_POST[&#39;filename&#39;];</span>
<span class="x">    //echo $filename;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">上記の形式で記述した部分は、入力された内容をphp部で扱う変数に格納する役割だ。</div>
<div class="line">コメントアウトしている<code class="docutils literal notranslate"><span class="pre">echo</span></code>部は出力が正しいかのテスト時に使える。</div>
<div class="line">セリフ、タイミングにあたる<code class="docutils literal notranslate"><span class="pre">word</span></code>、<code class="docutils literal notranslate"><span class="pre">timing</span></code>や星座絵にあたる<code class="docutils literal notranslate"><span class="pre">projector</span></code>、各フォームのON/OFFボタンにあたる<code class="docutils literal notranslate"><span class="pre">on_off</span></code>については、配列として格納している。
これは、1つの指示書内にこれらが複数あるからである。</div>
<div class="line">また、現在のフォーム数もこの形式で受け取って、<code class="docutils literal notranslate"><span class="pre">$count</span></code>という変数に格納している。</div>
<div class="line">ここで注意してほしいのが、<code class="docutils literal notranslate"><span class="pre">projector</span></code>については、1個目のフォームの、1番上の星座絵用セレクトボックスがprojector_a[0]、1個目のフォームの、上から2番目のものは<strong>projector_a[1]ではなく、projector_b[0]</strong>になるということである。<code class="docutils literal notranslate"><span class="pre">on_off</span></code>のラジオボタンも同じ仕様になっている。</div>
<div class="line">あらかた作った後で、この分かりにくさに気が付いてしまったが時間的に修正できなかったのでこのままである。非常に分かりにくい仕様になってしまって申し訳ない。</div>
</div>
</div>
<div class="section" id="id7">
<h4>JSONファイルとして出力するための雛形の作成<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">$DATA_ARRAY = array(</span>
<span class="x">    &quot;info&quot; =&gt; array(</span>
<span class="x">        &quot;day&quot; =&gt; $day,</span>
<span class="x">        &quot;title&quot; =&gt; $title,</span>
<span class="x">        &quot;name&quot; =&gt; $staffname,</span>
<span class="x">    ),</span>
<span class="x">    &quot;scenario&quot; =&gt; array(</span>
<span class="x">        array(</span>
<span class="x">            &quot;timing&quot; =&gt; &quot;&quot;,</span>
<span class="x">            &quot;word&quot; =&gt; &quot;&quot;,</span>
<span class="x">            &quot;projector&quot; =&gt; array(</span>
<span class="x">                &quot;Fst&quot; =&gt; 1,</span>
<span class="x">                &quot;Gxy&quot; =&gt; 1,</span>
<span class="x">             ),</span>
<span class="x">        ),</span>
<span class="x">    ),</span>
<span class="x">);</span>
</pre></div>
</div>
<p>上記の部分は、JSONファイルを作成する際のいわば初期設定にあたる部分を作るためのものである。指示書用のJSONファイルをいくつか見てもらえればすぐ分かると思うが、
各JSONファイルの冒頭部は<code class="docutils literal notranslate"><span class="pre">day</span></code>、<code class="docutils literal notranslate"><span class="pre">title</span></code>、<code class="docutils literal notranslate"><span class="pre">name</span></code>以外は全て一致している。この部分を配列として作成するのが上記コードである。この雛形に、他の星座絵やそのON/OFFについての
情報を加えていき、最終的にJSONとして出力する形である。この部分の記法については<a class="reference external" href="https://syncer.jp/how-to-use-json">こちらのページ</a>が大いに参考になった。</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">$word = str_replace(array(&quot;\r&quot;, &quot;\n&quot;), &#39;&#39;, $word);</span>
</pre></div>
</div>
<p>このコードはセリフ部分に書き込まれた内容から、改行コードを削除するためのものである。載せる場所に困ったので、ここに記載する。
セリフ部分に改行が入っていると指示書中に変な文字化けが発生することが指示書作成中に発覚したため、急遽追加した箇所である。
これにより、改行コードによる文字化けは防げるようになったが、同時に、そもそもセリフが改行されなくなるというデメリットも発生するようになった。(当然だが)
具体的には、長いセリフの場合にAcrab上で読みにくくなる、Acrab上で「次へ」/「前へ」ボタンが大きく横に伸びてしまうことがあるなどの点が欠点である。
このコードを置き換える、削除する、AcrabのCSSをいじってデザイン面からなんとかする…等の対応をしてほしいところである。</p>
</div>
<div class="section" id="id8">
<h4>星座絵用セレクトボックスで、星座が未選択の場合の配列からの削除<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h4>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">for($n = 0;$n &lt; $count; $n++){</span>
<span class="x">        if($projector_a[$n] == &quot;XXX&quot;){</span>
<span class="x">            unset($projector_a[$n]);</span>
<span class="x">            unset($on_off_a[$n]);</span>
<span class="x">        }</span>
<span class="x">        if($projector_b[$n] == &quot;XXX&quot;){</span>
<span class="x">            unset($projector_b[$n]);</span>
<span class="x">            unset($on_off_b[$n]);</span>
<span class="x">        }</span>
<span class="x">        if($projector_c[$n] == &quot;XXX&quot;){</span>
<span class="x">            unset($projector_c[$n]);</span>
<span class="x">            unset($on_off_c[$n]);</span>
<span class="x">        }</span>
<span class="x">        if($projector_d[$n] == &quot;XXX&quot;){</span>
<span class="x">            unset($projector_d[$n]);</span>
<span class="x">            unset($on_off_d[$n]);</span>
<span class="x">        }</span>
<span class="x">        if($projector_e[$n] == &quot;XXX&quot;){</span>
<span class="x">            unset($projector_e[$n]);</span>
<span class="x">            unset($on_off_e[$n]);</span>
<span class="x">        }</span>

<span class="x">    }</span>
</pre></div>
</div>
<p>星座絵がセレクトボックスで選択されている場合、各星座に対応した3文字のアルファベットがphp側に送信されるが、未選択の場合は<code class="docutils literal notranslate"><span class="pre">XXX</span></code>を送るように割り当てている。
そこで、配列である<code class="docutils literal notranslate"><span class="pre">$projector</span></code>と<code class="docutils literal notranslate"><span class="pre">$on_off</span></code>の中から、<code class="docutils literal notranslate"><span class="pre">XXX</span></code>に対応する部分を削除するためのコードが上記のコードである。
これで一応はちゃんと動くのだが、冒頭で触れた<strong>大量のエラーの一番の原因</strong>となっている部分でもある。もっと良い方法がある気がしてならないが、作成者の知識ではこれが限界だった。</p>
</div>
<div class="section" id="on-off">
<h4>on/off関連の配列作成<a class="headerlink" href="#on-off" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>on/offラジオボタンの情報(0か1)は配列として格納しているが、実はこの情報は数値としての<code class="docutils literal notranslate"><span class="pre">int型</span></code>ではなく、<code class="docutils literal notranslate"><span class="pre">string型</span></code>として格納されている。これを、</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">$on_off_int_a = clone_int($on_off_a);</span>
<span class="x">...</span>
<span class="x">function clone_int($array){</span>
<span class="x">        if(is_array($array)){</span>
<span class="x">            return array_map(&quot;clone_int&quot;,$array);</span>
<span class="x">        }else{</span>
<span class="x">            return intval($array);</span>
<span class="x">        }</span>
<span class="x">    }</span>
</pre></div>
</div>
<p>と、上記の記述でint型の配列に作成しなおしている。</p>
</div>
<div class="section" id="scinariojson">
<h4>scinarioの中に入れる配列の作成とJSONの出力<a class="headerlink" href="#scinariojson" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>ここまでで<code class="docutils literal notranslate"><span class="pre">scenario</span></code>に入れるデータの用意が全て終わったため、<code class="docutils literal notranslate"><span class="pre">scenario</span></code>以下の配列を作る。</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">$DATA_ARRAY[&quot;scenario&quot;][$i][&quot;projector&quot;] = array_filter($DATA_ARRAY[&quot;scenario&quot;][$i][&quot;projector&quot;],&quot;strlen&quot;);</span>
</pre></div>
</div>
<p>上記の記述は<code class="docutils literal notranslate"><span class="pre">projector</span></code>内の空の要素を一括で削除するものである。</p>
<p>配列が出来上がったら、あとはJSONを出力するのみ。</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">$make = json_encode($DATA_ARRAY,JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT);</span>
</pre></div>
</div>
<p>上記の記述だけで、ここまで作ってきた配列($DATA_ARRAY)をJSONに変換して出力できる。後半は出力形式の指定なので、正直おまじないに近い。何か追加したい人は別途調べてみてほしい。</p>
<p>出来上がったJSONファイルは、</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">if($filename){</span>
<span class="x">        file_put_contents(&quot;scenario/&quot;.$filename.&quot;.json&quot;,$make);</span>
<span class="x">        $result = file_get_contents(&quot;scenario/&quot;.$filename.&quot;.json&quot;);</span>
<span class="x">    }</span>
</pre></div>
</div>
<p>の記述により、<strong>GRAFFASディレクトリ内の</strong><code class="docutils literal notranslate"><span class="pre">GRAFFIAS/scenario</span></code>ディレクトリに、<code class="docutils literal notranslate"><span class="pre">(ファイル名).json</span></code>の形式でJSONが出力される。最初の方にも書いたが、このままでは<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>から参照できないので注意。
実際に使う場合は、<strong>ACRAB/scenarioディレクトリ内に、GRAFFIAS/scenarioディレクトリの中身をコピーして使う</strong>こと。</p>
</div>
<div class="section" id="json-1">
<span id="id9"></span><h4>JSONリストの作成<a class="headerlink" href="#json-1" title="このヘッドラインへのパーマリンク">¶</a></h4>
<p>全てのJSON作成が終わったら、<code class="docutils literal notranslate"><span class="pre">Acrab</span></code>が参照できるJSONリストを、JSON形式で出力する。</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span></span><span class="x">if(isset($_POST[&#39;listmake&#39;])){</span>
<span class="x">        foreach(glob(&quot;scenario/*.json&quot;) as $ListMake){</span>
<span class="x">            $FileList[] = $ListMake;</span>
<span class="x">    }</span>
<span class="x">        for($j=0;$j&lt;count($FileList);$j++){</span>
<span class="x">            $FileListResult[&quot;scenariolist&quot;][$j] = $FileList[$j];</span>
<span class="x">        }</span>
<span class="x">    $FileListMake = json_encode($FileListResult,JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT);</span>
<span class="x">    file_put_contents(&quot;../scenario_list.json&quot;,$FileListMake);</span>
<span class="x">    }</span>
</pre></div>
</div>
<p>上記の記述により、「JSONリストの作成」を押すとJSONファイルの一覧をJSON形式で出力したものが<strong>GRAFFIASディレクトリの1つ上のディレクトリ</strong>内に出力される。</p>
</div>
</div>
</div>
<div class="section" id="id10">
<h2>今後の課題点<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>知識0からのスタート＆1週間弱で作ったプログラムなので、非常に課題点が多い。ここで挙げた点以外にも、何か気づくところあればどんどん修正なり、機能追加なりしてほしい。
よりよいものが作れそうであれば、もう原型残さず改造でいいレベルでもある。</p>
<ul class="simple">
<li>使い始める前の、HTML部の書き換えが面倒。これをさくっと選択形式で直せるような仕様にすると後々楽かも…？</li>
<li>現状指示書を作る機能しかないので、
Acrabの方でファイルを書き換える作業には非対応。ただ、GRAFFIASは色んな人にGRAFFIAS単体で渡して使ってもらうのを想定しているので、そこまで作成するなら別でAcrab用設定画面UIを作った方が便利な可能性は高い</li>
<li>改行コードを一括削除する仕様にしたが、長いセリフが来ると読みにくい＆ACRABのボタンレイアウトが崩れる。これはAcrabで時々指示書の表示チェックをしながら、AcrabのCSSも弄るのを考えておくといいかもしれない。</li>
<li><strong>肝心の星座グループ指定が機能していない。</strong>これはGRAFFIAS自体の問題ではないが、かなりの痛手である。原因はAcrabにあるのが分かっているので、是非本番までに直していただきたい。</li>
<li>エラーがとにかく多い。これでどのような問題が発生しているかはよく分かっていないが、動作の遅さがどうしても気になるなら改善すべき…なのかもしれない。</li>
</ul>
</div>
</div>


            </div>
            <div class="articleComments">
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../haisen.html" class="btn btn-neutral float-right" title="配線" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="acrab-code.html" class="btn btn-neutral" title="無線制御(Acrabの実装解説)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Nichiden Project.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.9 RC',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>